<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3.6. USB &mdash; JL Project Documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../https://doc.zh-jieli.com/static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/documentation_options.js?v=fa47ad08"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="https://doc.zh-jieli.com/static/js/custom.js"></script>
        <script src="../../_static/js/custom.js?v=bfa33168"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="3.7. rdec" href="rdec.html" />
    <link rel="prev" title="3.5. iic" href="iic.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> JieLi_蓝牙音频
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">SDK入门</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../framework/index.html">1. 技术框架</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/index.html">2. 快速入门</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">SDK Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../earphone/index.html">1. 简介</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../audio/index.html">1. 音频播放</a></li>
<li class="toctree-l1"><a class="reference internal" href="../btstack/index.html">2. 蓝牙协议栈</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">3. 外设驱动</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="gpio.html">3.1. gpio</a></li>
<li class="toctree-l2"><a class="reference internal" href="gptimer.html">3.2. gptimer</a></li>
<li class="toctree-l2"><a class="reference internal" href="gpadc.html">3.3. gpadc</a></li>
<li class="toctree-l2"><a class="reference internal" href="uart.html">3.4. uart</a></li>
<li class="toctree-l2"><a class="reference internal" href="iic.html">3.5. iic</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">3.6. USB</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#api">3.6.1. 公共API</a></li>
<li class="toctree-l3"><a class="reference internal" href="#usbapi">3.6.2. USB从机API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">3.6.2.1. 应用层调用的API</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">3.6.2.2. 内层功能逻辑API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id3">3.6.3. USB主机API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id4">3.6.3.1. 应用层调用的API</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">3.6.3.2. 内层功能逻辑API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id6">3.6.4. 配置项</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">3.6.5. 类型引用</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#structures">3.6.5.1. Structures</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enumerations">3.6.5.2. Enumerations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#macros">3.6.5.3. Macros</a></li>
<li class="toctree-l4"><a class="reference internal" href="#type-definitions">3.6.5.4. Type Definitions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="rdec.html">3.7. rdec</a></li>
<li class="toctree-l2"><a class="reference internal" href="mcpwm.html">3.8. mcpwm</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="pmu/index.html">4. 电源管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pwm_led/index.html">5. LED状态显示</a></li>
<li class="toctree-l1"><a class="reference internal" href="../system/file_system/index.html">6. 文件系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../system/os/index.html">7. 操作系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../system/timer/index.html">8. 定时器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../system/clock_manage/index.html">9. 时钟管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_manager/index.html">10. 设备管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../system/%E9%80%9A%E7%94%A8%E7%BB%84%E4%BB%B6/index.html">11. 通用组件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../audio_config/index.html">12. 音频配置</a></li>
<li class="toctree-l1"><a class="reference internal" href="../audio_flow/index.html">13. 音频流程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../audio_effects/index.html">14. 音效调试</a></li>
<li class="toctree-l1"><a class="reference internal" href="../audio_cvp/index.html">15. 通话清晰语音</a></li>
<li class="toctree-l1"><a class="reference internal" href="../audio_FAQ/index.html">16. 音频FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../system/report/index.html">17. 系统状态报告</a></li>
<li class="toctree-l1"><a class="reference internal" href="../earphone_le_audio/index.html">18. LE_Audio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1T2/index.html">19. 1T2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../report/index.html">20. SDK测试报告</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">JieLi_蓝牙音频</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html"><span class="section-number">3. </span>外设驱动</a> &raquo;</li>
      <li><span class="section-number">3.6. </span>USB</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="usb">
<h1><span class="section-number">3.6. </span>USB<a class="headerlink" href="#usb" title="Link to this heading"></a></h1>
<p>USB驱动程序支持配置成High-Speed和Full-Speed两种工作模式（High-Speed需要芯片支持），方便用户应用在不同的场景中。USB接口支持OTG，可以实现主从机热插拔检测。协议栈支持主机驱动和从机驱动，拥有丰富的设备类协议，其中：</p>
<dl class="simple">
<dt>从机模式支持的协议：</dt><dd><ul class="simple">
<li><p>Mass Storage Class (MSC)</p></li>
<li><p>Usb Audio CLass (UAC)</p></li>
<li><p>Human Interface Device Class (HID)</p></li>
<li><p>Communications Device Class (CDC)</p></li>
<li><p>Apple MFI</p></li>
</ul>
</dd>
<dt>主机模式支持的协议：</dt><dd><ul class="simple">
<li><p>Mass Storage Class (MSC)</p></li>
<li><p>Usb Audio Class (UAC)</p></li>
<li><p>Human Interface Device Class (HID)</p></li>
<li><p>ADB &amp; AOA</p></li>
</ul>
</dd>
</dl>
<p>驱动程序支持丰富的配置项，默认配置项在文件usb_std_class_def.h和usb_common_def.h内，用户可以#include配置文件后，通过重定义宏来实现客制化需求。</p>
<p><strong>芯片USB端点DMA寻址支持情况</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head" rowspan="2"></th>
<th class="head" colspan="2"><p>Full-Speed</p></th>
<th class="head" colspan="2"><p>High-Speed</p></th>
</tr>
<tr class="row-even"><th class="head"><p>TX</p></th>
<th class="head"><p>RX</p></th>
<th class="head"><p>TX</p></th>
<th class="head"><p>RX</p></th>
</tr>
</thead>
<tbody>
<tr class="row-odd"><td><p>EP0</p></td>
<td><p>64</p></td>
<td><p>64</p></td>
<td><p>1024</p></td>
<td><p>1024</p></td>
</tr>
<tr class="row-even"><td><p>EP1</p></td>
<td><p>1024</p></td>
<td><p>1024</p></td>
<td><p>1024</p></td>
<td><p>1024</p></td>
</tr>
<tr class="row-odd"><td><p>EP2</p></td>
<td><p>1024</p></td>
<td><p>1024</p></td>
<td><p>1024</p></td>
<td><p>1024</p></td>
</tr>
<tr class="row-even"><td><p>EP3</p></td>
<td><p>1024</p></td>
<td><p>1024</p></td>
<td><p>4096</p></td>
<td><p>4096</p></td>
</tr>
<tr class="row-odd"><td><p>EP4</p></td>
<td><p>1024</p></td>
<td><p>1024</p></td>
<td><p>4096</p></td>
<td><p>4096</p></td>
</tr>
<tr class="row-even"><td><p>EP5</p></td>
<td><p>N/A</p></td>
<td><p>N/A</p></td>
<td><p>64</p></td>
<td><p>64</p></td>
</tr>
<tr class="row-odd"><td><p>EP6</p></td>
<td><p>N/A</p></td>
<td><p>N/A</p></td>
<td><p>64</p></td>
<td><p>64</p></td>
</tr>
</tbody>
</table>
<p><strong>芯片usb传输速率支持</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Chip</p></th>
<th class="head"><p>Speed</p></th>
<th class="head"><p>bps</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ul class="simple">
<li><p>JL700N</p></li>
<li><p>JL701N</p></li>
<li><p>JL706N</p></li>
<li><p>JL708N</p></li>
</ul>
</td>
<td><p>Full-Speed</p></td>
<td><p>12Mbps</p></td>
</tr>
<tr class="row-odd"><td><ul class="simple">
<li><p>JL703N</p></li>
</ul>
</td>
<td><p>High-Speed</p></td>
<td><p>480Mbps</p></td>
</tr>
</tbody>
</table>
<section id="api">
<h2><span class="section-number">3.6.1. </span>公共API<a class="headerlink" href="#api" title="Link to this heading"></a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">usb_memory_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</pre></div>
</div>
<p>初始化端点dma buffer内存池，需要在启动host或者device前调用</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>固定为0</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">usb_otg_init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_node</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">node</span><span class="p">,</span><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span>
</pre></div>
</div>
<p>OTG插拔检测初始化</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>*node – 填NULL即可</p></li>
<li><p>*arg – 需要填 <a class="reference internal" href="#struct-otg-dev-data">struct otg_dev_data</a> 类型结构体</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>固定为0</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>usb_otg_init()的参数列表比较奇怪，是因为这个函数以前是赋值给struct device_operations的成员int (*init)(const struct dev_node *node, void *)的，目前为了历史兼容保留了函数接口形式。</p>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">u32</span><span class="w"> </span><span class="n">usb_otg_online</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">usb_id</span><span class="p">)</span>
</pre></div>
</div>
<p>获取otg当前状态</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>usb_id – usb设备号，首个usb设备号是0</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>otg状态，参考 <a class="reference internal" href="#idle-mode">IDLE_MODE</a></p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="n">usb_message_to_stack</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">sync</span><span class="p">)</span>
</pre></div>
</div>
<p>发送消息给usb_task</p>
<dl class="field-list">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul>
<li><p>msg – 需要发送的消息，参考 <a class="reference internal" href="#usbstack-otg-msg">USBSTACK_OTG_MSG</a></p></li>
<li><p>*arg – 消息的参数列表</p></li>
<li><p>sync – 是否等待执行完毕</p>
<blockquote>
<div><ul class="simple">
<li><p>0 不等待</p></li>
<li><p>1 等待</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>无</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>sync用于等待usb_task执行完消息，例如接下来的代码需要usb打开后才可以执行，则在msg填USBSTACK_START时将sync填1</p>
</dd>
</dl>
</section>
<section id="usbapi">
<h2><span class="section-number">3.6.2. </span>USB从机API<a class="headerlink" href="#usbapi" title="Link to this heading"></a></h2>
<section id="id1">
<h3><span class="section-number">3.6.2.1. </span>应用层调用的API<a class="headerlink" href="#id1" title="Link to this heading"></a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="n">usb_start</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">usbfd</span><span class="p">)</span>
</pre></div>
</div>
<p>打开usb device</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>usbfd – usb设备号，首个usb设备号是0</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>无</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="n">usb_pause</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">usbfd</span><span class="p">)</span>
</pre></div>
</div>
<p>挂起usb device，用于需要暂停usb功能的场景，例如从PC模式切换到其他模式</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>usbfd – usb设备号，首个usb设备号是0</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>无</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="n">usb_stop</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">usbfd</span><span class="p">)</span>
</pre></div>
</div>
<p>关闭usb device，用于usb离线时关闭usb的场合</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>usbfd – usb设备号，首个usb设备号是0</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>无</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">pc_device_event_handler</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">msg</span><span class="p">)</span>
</pre></div>
</div>
<p>处理otg从机消息</p>
<dl class="field-list">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>*msg – otg消息</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>是否要切模式</p>
<blockquote>
<div><ul class="simple">
<li><p>0 不切模式</p></li>
<li><p>1 切入PC模式</p></li>
<li><p>2 切出PC模式</p></li>
</ul>
</div></blockquote>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
</section>
<section id="id2">
<h3><span class="section-number">3.6.2.2. </span>内层功能逻辑API<a class="headerlink" href="#id2" title="Link to this heading"></a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">usb_device_mode</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">usb_id</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">class</span><span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple">
<li><p>设备类的注册和usb硬件init</p></li>
<li><p>设备类的注销和usb硬件uninit</p></li>
</ol>
<dl class="field-list">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul>
<li><p>usb_id – usb设备号，首个usb设备号是0</p></li>
<li><p>class – 设备类</p>
<blockquote>
<div><ul class="simple">
<li><p>可以是多个设备类宏的组合，参考 <a class="reference internal" href="#class-definitions">class_definitions</a></p></li>
<li><p>填0表示注销设备类，uninit usb</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>固定为0</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="n">usb_add_desc_config</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">usb_id</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">desc_config</span><span class="w"> </span><span class="n">desc</span><span class="p">)</span>
</pre></div>
</div>
<p>添加1个设备类描述符的回调函数，描述符应包括完整的interface desc + class desc + endpoint desc，回调函数应自己实现修改interface号</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>usb_id – usb设备号，首个usb设备号是0</p></li>
<li><p>index – 序号，从0开始，每调一次该函数index应该加1</p></li>
<li><p>desc – <a class="reference internal" href="#desc-config">desc_config</a> 类型的函数指针</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>无</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">u32</span><span class="w"> </span><span class="n">usb_set_interface_hander</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">usb_id</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">itf_num</span><span class="p">,</span><span class="w"> </span><span class="n">itf_hander</span><span class="w"> </span><span class="n">hander</span><span class="p">)</span>
</pre></div>
</div>
<p>设置类特定请求回调函数</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>usb_id – usb设备号，首个usb设备号是0</p></li>
<li><p>itf_num – 接口号</p></li>
<li><p>hander – <a class="reference internal" href="#itf-hander">itf_hander</a> 类型的函数指针</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>接口号</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="n">usb_set_setup_recv</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">usb_device_t</span><span class="w"> </span><span class="o">*</span><span class="n">usb_device</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">recv</span><span class="p">)</span>
</pre></div>
</div>
<p>设置类特定请求out stage回调函数</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>*usb_device – usb设备句柄</p></li>
<li><p>*recv – <a class="reference internal" href="#setup-recv">setup_recv</a> 类型的函数指针</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>接口号</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">u32</span><span class="w"> </span><span class="n">usb_set_reset_hander</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">usb_id</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">itf_num</span><span class="p">,</span><span class="w"> </span><span class="n">itf_reset_hander</span><span class="w"> </span><span class="n">hander</span><span class="p">)</span>
</pre></div>
</div>
<p>设置设备类收到usb reset时的回调函数，回调函数需要实现端点初始化</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>usb_id – usb设备号，首个usb设备号是0</p></li>
<li><p>itf_num – 接口号</p></li>
<li><p>hander – <a class="reference internal" href="#itf-reset-hander">itf_reset_hander</a> 类型的函数指针</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>接口号</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="n">usb_set_setup_phase</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">usb_device_t</span><span class="w"> </span><span class="o">*</span><span class="n">usb_device</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">setup_phase</span><span class="p">)</span>
</pre></div>
</div>
<p>设置ep0控制传输的阶段</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>*usb_device – usb设备句柄</p></li>
<li><p>setup_phase – 阶段，参考 <a class="reference internal" href="#setup-stage">setup_stage</a></p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>无</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">usb_set_data_payload</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">usb_device_t</span><span class="w"> </span><span class="o">*</span><span class="n">usb_device</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">usb_ctrlrequest</span><span class="w"> </span><span class="o">*</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
</pre></div>
</div>
<p>准备ep0 控制传输in stage的数据</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>*usb_device – usb设备句柄</p></li>
<li><p>*req – usb请求，参考 <a class="reference internal" href="#struct-usb-ctrlrequest">struct usb_ctrlrequest</a></p></li>
<li><p>*data – in stage要发送的数据</p></li>
<li><p>len – 数据长度</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>发送buffer的地址</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>如果填进data的数据是const类型，则可以使用返回值进一步修改需要发送的数据</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">u32</span><span class="w"> </span><span class="n">usb_g_set_intr_hander</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">usb_id</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ep</span><span class="p">,</span><span class="w"> </span><span class="n">usb_interrupt</span><span class="w"> </span><span class="n">hander</span><span class="p">)</span>
</pre></div>
</div>
<p>设置端点中断处理函数</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>usb_id – usb设备号，首个usb设备号是0</p></li>
<li><p>ep – 端点号</p></li>
<li><p>hander – <a class="reference internal" href="#usb-interrupt">usb_interrupt</a> 类型回调函数</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>固定为0</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>IN端点需要 ep | <a class="reference internal" href="#usb-dir-in">USB_DIR_IN</a></p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">u32</span><span class="w"> </span><span class="n">usb_g_ep_config</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ep</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">dma_size</span><span class="p">)</span>
</pre></div>
</div>
<p>usb从机端点初始化配置</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>id – usb设备号，首个usb设备号是0</p></li>
<li><p>ep – 端点号</p></li>
<li><p>type – 传输类型，参考 <a class="reference internal" href="#ep-trans-type">ep_trans_type</a></p></li>
<li><p>ie – 中断使能</p></li>
<li><p>ptr – 端点dma buffer起始地址</p></li>
<li><p>dma_size – 端点最大包长</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>固定为0</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>IN端点需要 ep | <a class="reference internal" href="#usb-dir-in">USB_DIR_IN</a></p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//下列接口功能相同，都是usb_g_ep_read()的封装</span>
<span class="n">u32</span><span class="w"> </span><span class="n">usb_g_ep_read</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">usb_id</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ep</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">block</span><span class="p">)</span>

<span class="n">u32</span><span class="w"> </span><span class="n">usb_g_bulk_read</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">usb_id</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ep</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">block</span><span class="p">)</span>

<span class="n">u32</span><span class="w"> </span><span class="n">usb_g_intr_read</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">usb_id</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ep</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w">  </span><span class="n">block</span><span class="p">)</span>

<span class="n">u32</span><span class="w"> </span><span class="n">usb_g_iso_read</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">usb_id</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ep</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">block</span><span class="p">)</span>
</pre></div>
</div>
<p>usb从机端点接收接口</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>usb_id – usb设备号，首个usb设备号是0</p></li>
<li><p>ep – 端点号</p></li>
<li><p>ptr – 读出接收数据的缓存</p></li>
<li><p>len – 期望接收的长度</p></li>
<li><p>block – 当usb未收到数据时，是否阻塞</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>读出数据的长度，0表示传输失败</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//下列接口功能相同，都是usb_g_ep_write()的封装</span>
<span class="n">u32</span><span class="w"> </span><span class="n">usb_g_ep_write</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">usb_id</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ep</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>

<span class="n">u32</span><span class="w"> </span><span class="n">usb_g_bulk_write</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">usb_id</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ep</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>

<span class="n">u32</span><span class="w"> </span><span class="n">usb_g_intr_write</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">usb_id</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ep</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>

<span class="n">u32</span><span class="w"> </span><span class="n">usb_g_iso_write</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">usb_id</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ep</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
</pre></div>
</div>
<p>usb从机端点发送接口</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>usb_id – usb设备号，首个usb设备号是0</p></li>
<li><p>ep – 端点号</p></li>
<li><p>ptr – 发送数据的缓存</p></li>
<li><p>len – 期望发送的长度</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>发送数据的长度，0表示传输失败</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">usb_alloc_ep_dmabuffer</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">usb_id</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ep</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">dma_size</span><span class="p">)</span>
</pre></div>
</div>
<p>usb从机分配端点dma buffer</p>
<dl class="field-list">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>usb_id – usb设备号，首个usb设备号是0</p></li>
<li><p>ep – 端点号</p></li>
<li><p>dma_size – 需要的DMA内存大小</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>分配出来的buffer首地址，NULL表示分配失败</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>IN端点需要 ep | <a class="reference internal" href="#usb-dir-in">USB_DIR_IN</a></p>
<p>bulk传输的接收方向需要double-buffer，所以dma_size要填2倍大小</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="n">usb_free_ep_dmabuffer</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">usb_id</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">)</span>
</pre></div>
</div>
<p>usb从机释放端点dma buffer</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>usb_id – usb设备号，首个usb设备号是0</p></li>
<li><p>*buf – 需要释放的buffer首地址</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>无</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
</section>
</section>
<section id="id3">
<h2><span class="section-number">3.6.3. </span>USB主机API<a class="headerlink" href="#id3" title="Link to this heading"></a></h2>
<section id="id4">
<h3><span class="section-number">3.6.3.1. </span>应用层调用的API<a class="headerlink" href="#id4" title="Link to this heading"></a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">u32</span><span class="w"> </span><span class="n">usb_host_mount</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">retry</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">reset_delay</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">mount_timeout</span><span class="p">)</span>
</pre></div>
</div>
<p>usb主机挂载设备，实现的事务有usb chirp握手，获取描述符，解析设备类，推送设备上线消息</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>id – usb设备号，首个usb设备号是0</p></li>
<li><p>retry – 枚举失败重试枚举次数</p></li>
<li><p>reset_delay – 发送usb reset的时间</p></li>
<li><p>mount_timeout – 等待握手超时时间</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>0表示成功，非0表示错误号</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">u32</span><span class="w"> </span><span class="n">usb_host_unmount</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">id</span><span class="p">)</span>
</pre></div>
</div>
<p>usb主机卸载设备，推送离线消息</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>id – usb设备号，首个usb设备号是0</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>0表示成功，非0表示错误号</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">u32</span><span class="w"> </span><span class="n">usb_host_remount</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">retry</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">delay</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ot</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">notify</span><span class="p">)</span>
</pre></div>
</div>
<p>usb主机重新挂载设备，这个函数实现了先卸载再挂载的</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>id – usb设备号，首个usb设备号是0</p></li>
<li><p>retry – 枚举失败重试枚举次数</p></li>
<li><p>delay – 发送usb reset的时间</p></li>
<li><p>ot – 等待握手超时时间</p></li>
<li><p>notify – 是否推送remount消息</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>0表示成功，非0表示错误号</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device_operations</span><span class="w"> </span><span class="n">mass_storage_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">online</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usb_stor_online</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">open</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usb_stor_open</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usb_stor_read</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usb_stor_write</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">ioctl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usb_stor_ioctrl</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">close</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usb_stor_close</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
<p>mass storage 访问U盘的IO接口，一般不会直接调用，而是挂载到device接口使用，下面是使用的例子：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">extern</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device_operations</span><span class="w"> </span><span class="n">mass_storage_ops</span><span class="p">;</span>

<span class="c1">//设备注册表，sdk中都会有，只需要把需要挂载的设备填进表中</span>
<span class="n">REGISTER_DEVICES</span><span class="p">(</span><span class="n">device_table</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">//...（其他设备注册）</span>
<span class="cp">#if TCFG_UDISK_ENABLE</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;udisk0&quot;</span><span class="p">,</span><span class="w">   </span><span class="o">&amp;</span><span class="n">mass_storage_ops</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="c1">//...</span>
<span class="p">};</span>

<span class="n">u8</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
<span class="kt">int</span><span class="w"> </span><span class="n">NumOfBlocks</span><span class="p">;</span>
<span class="n">u32</span><span class="w"> </span><span class="n">block_size</span><span class="p">,</span><span class="w"> </span><span class="n">total_blocks</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev_open</span><span class="p">(</span><span class="s">&quot;udisk0&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w">  </span><span class="c1">//打开设备，打开成功返回句柄，失败返回NULL</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">dev_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">IOCTL_GET_BLOCK_SIZE</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">block_size</span><span class="p">);</span><span class="w">  </span><span class="c1">//获取块大小</span>
<span class="w">    </span><span class="n">dev_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">IOCTL_GET_BLOCK_NUMBER</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">total_blocks</span><span class="p">);</span><span class="w">  </span><span class="c1">//获取总块数</span>
<span class="w">    </span><span class="n">NumOfBlocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev_bulk_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">  </span><span class="c1">//从块地址2读取1块数据（512字节），成功则返回读出多少块，失败返回 &lt; 0 的错误码</span>
<span class="w">    </span><span class="n">NumOfBlocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev_bulk_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">  </span><span class="c1">//向块地址2写入1块数据（512字节），成功则返回写入多少块，失败返回 &lt; 0 的错误码</span>
<span class="w">    </span><span class="n">dev_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span><span class="w">  </span><span class="c1">//关闭设备</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id5">
<h3><span class="section-number">3.6.3.2. </span>内层功能逻辑API<a class="headerlink" href="#id5" title="Link to this heading"></a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">usb_host_force_reset</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">usb_id</span><span class="p">)</span>
</pre></div>
</div>
<p>usb主机强制复位设备</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>id – usb设备号，首个usb设备号是0</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>0表示成功，非0表示错误号</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">usb_control_msg</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">usb_host_device</span><span class="w"> </span><span class="o">*</span><span class="n">host_dev</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">requesttype</span><span class="p">,</span><span class="w"> </span><span class="n">u16</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">u16</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">u16</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
</pre></div>
</div>
<p>usb主机控制传输</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>*host_dev – usb主机句柄</p></li>
<li><p>request – 控制传输bRequest字段</p></li>
<li><p>requesttype – 控制传输bmRequestType字段</p></li>
<li><p>value – 控制传输wValue字段</p></li>
<li><p>index – 控制传输wIndex字段</p></li>
<li><p>*data – 控制传输数据阶段的数据</p></li>
<li><p>size – 控制传输wLength字段</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>0表示成功，非0表示错误号</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">s32</span><span class="w"> </span><span class="n">usb_bulk_only_send</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">host_ep</span><span class="p">,</span><span class="w"> </span><span class="n">u16</span><span class="w"> </span><span class="n">txmaxp</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">target_ep</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">pBuf</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
</pre></div>
</div>
<p>usb主机bulk传输发送数据</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>*device – 设备句柄</p></li>
<li><p>host_ep – 主机端点号</p></li>
<li><p>txmaxp – TX最大包长</p></li>
<li><p>target_ep – 设备端点号，指从设备描述符中获取的端点号</p></li>
<li><p>*pBuf – 发送数据buffer</p></li>
<li><p>len – 发送数据长度</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>&gt;= 0表示成功发送的数据长度，&lt; 0表示错误号</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">s32</span><span class="w"> </span><span class="n">usb_bulk_only_receive</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">host_ep</span><span class="p">,</span><span class="w"> </span><span class="n">u16</span><span class="w"> </span><span class="n">rxmaxp</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">target_ep</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">pBuf</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
</pre></div>
</div>
<p>usb主机bulk传输接收数据</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>*device – 设备句柄</p></li>
<li><p>host_ep – 主机端点号</p></li>
<li><p>rxmaxp – RX最大包长</p></li>
<li><p>target_ep – 设备端点号，指从设备描述符中获取的端点号</p></li>
<li><p>*pBuf – 接收数据buffer</p></li>
<li><p>len – 接收数据长度</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>&gt;= 0表示成功接收的数据长度，&lt; 0表示错误号</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">u32</span><span class="w"> </span><span class="n">usb_get_ep_num</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ep_dir</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">type</span><span class="p">)</span>
</pre></div>
</div>
<p>usb主机获取空闲端点，即分配未被指派的端点</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>id – usb设备号，首个usb设备号是0</p></li>
<li><p>ep_dir – 端点方向，<a class="reference internal" href="#usb-dir-in">USB_DIR_IN</a> or <a class="reference internal" href="#usb-dir-out">USB_DIR_OUT</a></p></li>
<li><p>type – 传输类型，参考 <a class="reference internal" href="#ep-trans-type">ep_trans_type</a></p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>分配到的端点号</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">usb_h_alloc_ep_buffer</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">usb_id</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ep</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">dma_size</span><span class="p">)</span>
</pre></div>
</div>
<p>usb主机分配端点dma buffer</p>
<dl class="field-list">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>usb_id – usb设备号，首个usb设备号是0</p></li>
<li><p>ep – 端点号</p></li>
<li><p>dma_size – 需要的DMA内存大小</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>分配到的dma buffer首地址，失败返回NULL</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>IN端点需要 ep | <a class="reference internal" href="#usb-dir-in">USB_DIR_IN</a></p>
<p>bulk传输的接收方向需要double-buffer，所以dma_size要填2倍大小</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="n">usb_h_free_ep_buffer</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">usb_id</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">)</span>
</pre></div>
</div>
<p>usb主机释放端点dma buffer</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>usb_id – usb设备号，首个usb设备号是0</p></li>
<li><p>*buf – dma buffer首地址</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>无</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">u32</span><span class="w"> </span><span class="n">usb_h_ep_config</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ep</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">interval</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">dma_size</span><span class="p">)</span>
</pre></div>
</div>
<p>usb主机端点初始化配置</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>id – usb设备号，首个usb设备号是0</p></li>
<li><p>ep – 端点号</p></li>
<li><p>type – 传输类型，参考 <a class="reference internal" href="#ep-trans-type">ep_trans_type</a></p></li>
<li><p>ie – 中断使能</p></li>
<li><p>interval – 对于intr传输及iso传输是指传输间隔，对于bulk传输是指收到多少次NAK就中止传输</p></li>
<li><p>ptr – dma buffer的首地址</p></li>
<li><p>dma_size – 需要的DMA内存大小</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>固定为0</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>IN端点需要 ep | <a class="reference internal" href="#usb-dir-in">USB_DIR_IN</a></p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="n">usb_h_set_ep_isr</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">usb_host_device</span><span class="w"> </span><span class="o">*</span><span class="n">host_dev</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ep</span><span class="p">,</span><span class="w"> </span><span class="n">usb_h_interrupt</span><span class="w"> </span><span class="n">hander</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
<p>usb主机设置端点中断回调函数</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>host_dev – usb主机句柄</p></li>
<li><p>ep – 端点号</p></li>
<li><p>hander – <a class="reference internal" href="#usb-h-interrupt">usb_h_interrupt</a> 类型的函数指针</p></li>
<li><p>*p – 函数指针hander的private data</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>无</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>IN端点需要 ep | <a class="reference internal" href="#usb-dir-in">USB_DIR_IN</a></p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="n">usb_set_intr_txe</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ep</span><span class="p">)</span>
</pre></div>
</div>
<p>usb主机使能端点tx中断</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>id – usb设备号，首个usb设备号是0</p></li>
<li><p>ep – 端点号的bitmap，例如BIT(1) | BIT(2)表示使能端点1，2的中断</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>无</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="n">usb_clr_intr_txe</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ep</span><span class="p">)</span>
</pre></div>
</div>
<p>usb主机禁用端点tx中断</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>id – usb设备号，首个usb设备号是0</p></li>
<li><p>ep – 端点号的bitmap，例如BIT(1) | BIT(2)表示禁用端点1，2的中断，填(u32)-1表示禁用所有端点中断</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>无</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="n">usb_set_intr_rxe</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ep</span><span class="p">)</span>
</pre></div>
</div>
<p>usb主机使能端点rx中断</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>id – usb设备号，首个usb设备号是0</p></li>
<li><p>ep – 端点号的bitmap，例如BIT(1) | BIT(2)表示使能端点1，2的中断</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>无</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="n">usb_clr_intr_rxe</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ep</span><span class="p">)</span>
</pre></div>
</div>
<p>usb主机禁用端点rx中断</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>id – usb设备号，首个usb设备号是0</p></li>
<li><p>ep – 端点号的bitmap，例如BIT(1) | BIT(2)表示禁用端点1，2的中断，填(u32)-1表示禁用所有端点中断</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>无</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">usb_h_ep_write_async</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">host_ep</span><span class="p">,</span><span class="w"> </span><span class="n">u16</span><span class="w"> </span><span class="n">txmaxp</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">target_ep</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">xfer</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">kstart</span><span class="p">)</span>
</pre></div>
</div>
<p>usb主机端点异步发送接口，一般用在中断的场景</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>id – usb设备号，首个usb设备号是0</p></li>
<li><p>host_ep – 主机端点号</p></li>
<li><p>txmaxp – 最大包长</p></li>
<li><p>target_ep – 设备端点号，指从设备描述符中获取的端点号</p></li>
<li><p>ptr – 发送数据的缓存</p></li>
<li><p>len – 发送长度</p></li>
<li><p>xfer – 传输类型，参考 <a class="reference internal" href="#ep-trans-type">ep_trans_type</a></p></li>
<li><p>kstart – 启动DMA发送</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>返回发送长度，&lt; 0表示错误号</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">u32</span><span class="w"> </span><span class="n">usb_h_ep_write</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">host_ep</span><span class="p">,</span><span class="w"> </span><span class="n">u16</span><span class="w"> </span><span class="n">txmaxp</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">target_ep</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">xfer</span><span class="p">)</span>
</pre></div>
</div>
<p>usb主机端点同步发送接口，用在线程中</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>id – usb设备号，首个usb设备号是0</p></li>
<li><p>host_ep – 主机端点号</p></li>
<li><p>txmaxp – 最大包长</p></li>
<li><p>target_ep – 设备端点号，指从设备描述符中获取的端点号</p></li>
<li><p>ptr – 发送数据的缓存</p></li>
<li><p>len – 发送长度</p></li>
<li><p>xfer – 传输类型，参考 <a class="reference internal" href="#ep-trans-type">ep_trans_type</a></p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>返回发送长度，&lt; 0表示错误号</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">usb_h_ep_read_async</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">host_ep</span><span class="p">,</span><span class="w">  </span><span class="n">u8</span><span class="w"> </span><span class="n">target_ep</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">xfer</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">kstart</span><span class="p">)</span>
</pre></div>
</div>
<p>usb主机端点异步接收接口，一般用在中断的场景</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>id – usb设备号，首个usb设备号是0</p></li>
<li><p>host_ep – 主机端点号</p></li>
<li><p>target_ep – 设备端点号，指从设备描述符中获取的端点号</p></li>
<li><p>ptr – 接收数据的缓存</p></li>
<li><p>len – 接收长度</p></li>
<li><p>xfer – 传输类型，参考 <a class="reference internal" href="#ep-trans-type">ep_trans_type</a></p></li>
<li><p>kstart – 启动DMA接收，接收完成在中断调用这个函数，kstart填0，就能读到接收的数据</p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>返回接收长度，&lt; 0表示错误号</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">u32</span><span class="w"> </span><span class="n">usb_h_ep_read</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">host_ep</span><span class="p">,</span><span class="w"> </span><span class="n">u16</span><span class="w"> </span><span class="n">rxmaxp</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">target_ep</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">xfer</span><span class="p">)</span>
</pre></div>
</div>
<p>usb主机端点同步接收接口，用在线程中</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>id – usb设备号，首个usb设备号是0</p></li>
<li><p>host_ep – 主机端点号</p></li>
<li><p>rxmaxp – 最大包长</p></li>
<li><p>target_ep – 设备端点号，指从设备描述符中获取的端点号</p></li>
<li><p>ptr – 接收数据的缓存</p></li>
<li><p>len – 接收长度</p></li>
<li><p>xfer – 传输类型，参考 <a class="reference internal" href="#ep-trans-type">ep_trans_type</a></p></li>
</ul>
</dd>
<dt class="field-even">返回值<span class="colon">:</span></dt>
<dd class="field-even"><p>返回接收长度，&lt; 0表示错误号</p>
</dd>
<dt class="field-odd">备注<span class="colon">:</span></dt>
<dd class="field-odd"><p>无</p>
</dd>
</dl>
</section>
</section>
<section id="id6">
<h2><span class="section-number">3.6.4. </span>配置项<a class="headerlink" href="#id6" title="Link to this heading"></a></h2>
<dl>
<dt>默认配置表：</dt><dd><p>apps/common/device/usb/usb_std_class_def.h</p>
<p>apps/common/device/usb/usb_common_def.h</p>
</dd>
</dl>
<p>用户可以在#include “*.h”默认配置表的基础上，对部分配置项进行重定义，这样就可以在不同的产品形态中使能不同的特性以及功能。以下是一些用户常用配置项目：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//usb从机模式使能</span>
<span class="cp">#define TCFG_PC_ENABLE  0</span>
<span class="c1">//USB主机总开关</span>
<span class="cp">#define TCFG_USB_HOST_ENABLE  1</span>
<span class="c1">//usb主机模式U盘功能使能</span>
<span class="cp">#define TCFG_UDISK_ENABLE                                   DISABLE_THIS_MOUDLE</span>
<span class="c1">//OTG设备使能，bitmap，USB0 = BIT(0)  USB1 = BIT(1)</span>
<span class="cp">#define TCFG_OTG_USB_DEV_EN                 BIT(0)</span>
<span class="c1">//VPWR(LDOIN)是否接到USB口</span>
<span class="cp">#define TCFG_USB_PORT_CHARGE   0</span>
<span class="c1">//USB CDC后台功能使能</span>
<span class="cp">#define TCFG_USB_CDC_BACKGROUND_RUN 0</span>
<span class="c1">//usb从机模式动态内存分配使能</span>
<span class="cp">#define USB_MALLOC_ENABLE                   0</span>
<span class="c1">//usb主机模式动态内存分配使能</span>
<span class="cp">#define USB_H_MALLOC_ENABLE         1</span>

<span class="cp">#if TCFG_USB_HOST_ENABLE</span>
<span class="c1">//usb主机枚举失败重试枚举次数</span>
<span class="cp">#define MOUNT_RETRY                         3</span>
<span class="c1">//usb主机发送usb reset的时间</span>
<span class="cp">#define MOUNT_RESET                         40</span>
<span class="c1">//usb主机等待握手超时时间</span>
<span class="cp">#define MOUNT_TIMEOUT                       50</span>
<span class="cp">#define TCFG_USB_HOST_ENABLE                1</span>
<span class="cp">#else</span>
<span class="cp">#define TCFG_USB_HOST_ENABLE                0</span>
<span class="cp">#endif</span>

<span class="c1">//usb otg从机上线检测计数</span>
<span class="cp">#define TCFG_OTG_SLAVE_ONLINE_CNT           3</span>
<span class="c1">//usb otg从机离线检测计数</span>
<span class="cp">#define TCFG_OTG_SLAVE_OFFLINE_CNT          2</span>
<span class="c1">//usb otg主机上线检测计数</span>
<span class="cp">#define TCFG_OTG_HOST_ONLINE_CNT            2</span>
<span class="c1">//usb otg主机离线检测计数</span>
<span class="cp">#define TCFG_OTG_HOST_OFFLINE_CNT           3</span>
<span class="c1">//usb otg检测时间间隔</span>
<span class="cp">#define TCFG_OTG_DET_INTERVAL               50</span>
</pre></div>
</div>
<p><strong>VID &amp; PID</strong></p>
<img alt="../../_images/usb_001.png" src="../../_images/usb_001.png" />
<p><strong>Manufacturer String</strong></p>
<img alt="../../_images/usb_002.png" src="../../_images/usb_002.png" />
<p><strong>Product String</strong></p>
<img alt="../../_images/usb_003.png" src="../../_images/usb_003.png" />
<p><strong>Serial Number String</strong></p>
<img alt="../../_images/usb_004.png" src="../../_images/usb_004.png" />
<p><strong>Audio的名称（扬声器、麦克风）</strong></p>
<img alt="../../_images/usb_005.png" src="../../_images/usb_005.png" />
<p><strong>设备管理器 - 磁盘驱动器 名称</strong></p>
<img alt="../../_images/usb_006.png" src="../../_images/usb_006.png" />
<img alt="../../_images/usb_007.png" src="../../_images/usb_007.png" />
<p><strong>文件管理器 - 可移动磁盘 修改卷标</strong></p>
<img alt="../../_images/usb_008.png" src="../../_images/usb_008.png" />
</section>
<section id="id7">
<h2><span class="section-number">3.6.5. </span>类型引用<a class="headerlink" href="#id7" title="Link to this heading"></a></h2>
<section id="structures">
<h3><span class="section-number">3.6.5.1. </span>Structures<a class="headerlink" href="#structures" title="Link to this heading"></a></h3>
<div class="highlight-c notranslate" id="struct-otg-dev-data"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">otg_dev_data</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">usb_dev_en</span><span class="p">;</span><span class="w"> </span><span class="c1">///&lt;有哪几个otg设备使能，如USB0，USB1。</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">slave_online_cnt</span><span class="p">;</span><span class="w"> </span><span class="c1">///&lt;从机上线阈值</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">slave_offline_cnt</span><span class="p">;</span><span class="w"> </span><span class="c1">///&lt;从机下线阈值</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">host_online_cnt</span><span class="p">;</span><span class="w"> </span><span class="c1">///&lt;主机上线阈值</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">host_offline_cnt</span><span class="p">;</span><span class="w"> </span><span class="c1">///&lt;主机下线阈值</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">detect_mode</span><span class="p">;</span><span class="w"> </span><span class="c1">///&lt;otg可用模式配置</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">detect_time_interval</span><span class="p">;</span><span class="w"> </span><span class="c1">///&lt;检测时间间隔，单位 ms</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">otg1</span><span class="p">;</span><span class="w"> </span><span class="c1">//需要使用双USB口独立配置时，在板级.c文件用户自定义一个otg信息的结构体，并指向它。</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="highlight-c notranslate" id="struct-usb-ctrlrequest"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">usb_ctrlrequest</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">bRequestType</span><span class="p">;</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">bRequest</span><span class="p">;</span>
<span class="w">    </span><span class="n">u16</span><span class="w"> </span><span class="n">wValue</span><span class="p">;</span>
<span class="w">    </span><span class="n">u16</span><span class="w"> </span><span class="n">wIndex</span><span class="p">;</span>
<span class="w">    </span><span class="n">u16</span><span class="w"> </span><span class="n">wLength</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>
</pre></div>
</div>
</section>
<section id="enumerations">
<h3><span class="section-number">3.6.5.2. </span>Enumerations<a class="headerlink" href="#enumerations" title="Link to this heading"></a></h3>
<div class="highlight-c notranslate" id="usbstack-otg-msg"><div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">USBSTACK_OTG_MSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x80</span><span class="p">,</span>
<span class="w">    </span><span class="n">USBSTACK_START</span><span class="p">,</span>
<span class="w">    </span><span class="n">USBSTACK_PAUSE</span><span class="p">,</span>
<span class="w">    </span><span class="n">USBSTACK_STOP</span><span class="p">,</span>
<span class="w">    </span><span class="n">USBSTACK_MSD_RUN</span><span class="p">,</span>
<span class="w">    </span><span class="n">USBSTACK_CDC_BACKGROUND</span><span class="p">,</span>
<span class="w">    </span><span class="n">USBSTACK_HOST_MOUNT</span><span class="p">,</span>
<span class="w">    </span><span class="n">USBSTACK_HOST_UNMOUNT</span><span class="p">,</span>
<span class="w">    </span><span class="n">USBSTACK_HOST_REMOUNT</span><span class="p">,</span>
<span class="w">    </span><span class="n">USBSTACK_HOST_MOUNT_AFTER</span><span class="p">,</span>
<span class="w">    </span><span class="n">USBSTACK_HOST_UNMOUNT_AFTER</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="highlight-c notranslate" id="idle-mode"><div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">IDLE_MODE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="c1">///&lt;空闲模式</span>
<span class="w">    </span><span class="n">DISCONN_MODE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="c1">///&lt;断连模式</span>
<span class="w">    </span><span class="n">HOST_MODE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="c1">///&lt;主机模式</span>
<span class="w">    </span><span class="n">PRE_SLAVE_MODE</span><span class="p">,</span><span class="w"> </span><span class="c1">///&lt;成为从机模式前的一个中间模式</span>
<span class="w">    </span><span class="n">SLAVE_MODE_WAIT_CONFIRMATION</span><span class="p">,</span><span class="w"> </span><span class="c1">///&lt;从机模式还需等待再次确认</span>
<span class="w">    </span><span class="n">SLAVE_MODE</span><span class="p">,</span><span class="w"> </span><span class="c1">///&lt;从机模式</span>
<span class="w">    </span><span class="n">CHARGE_MODE</span><span class="p">,</span><span class="w"> </span><span class="c1">///&lt;充电模式</span>
<span class="w">    </span><span class="n">OTG_USER_MODE</span><span class="p">,</span><span class="w"> </span><span class="c1">///&lt;用户模式，暂时未具体定义</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="macros">
<h3><span class="section-number">3.6.5.3. </span>Macros<a class="headerlink" href="#macros" title="Link to this heading"></a></h3>
<div class="highlight-c notranslate" id="class-definitions"><div class="highlight"><pre><span></span><span class="cp">#define     MASSSTORAGE_CLASS   0x00000001</span>
<span class="cp">#define     SPEAKER_CLASS       0x00000002</span>
<span class="cp">#define     MIC_CLASS           0x00000004</span>
<span class="cp">#define     HID_CLASS           0x00000008</span>
<span class="cp">#define     CDC_CLASS           0x00000010</span>
<span class="cp">#define     CUSTOM_HID_CLASS    0x00000020</span>

<span class="cp">#define     AUDIO_CLASS         (SPEAKER_CLASS|MIC_CLASS)</span>
</pre></div>
</div>
<div class="highlight-c notranslate" id="setup-stage"><div class="highlight"><pre><span></span><span class="c1">///USB Slave 控制传输各阶段</span>
<span class="cp">#define USB_EP0_STAGE_SETUP       0</span>
<span class="cp">#define USB_EP0_STAGE_IN          1</span>
<span class="cp">#define USB_EP0_STAGE_OUT         2</span>
<span class="cp">#define USB_EP0_SET_STALL         3</span>
<span class="cp">#define USB_EP0_IGNORE            4</span>
<span class="cp">#define USB_EP0_STAGE_NAK         5</span>
</pre></div>
</div>
<div class="highlight-c notranslate" id="ep-trans-type"><div class="highlight"><pre><span></span><span class="cp">#define USB_ENDPOINT_XFERTYPE_MASK  0x03    </span><span class="cm">/* in bmAttributes */</span>
<span class="cp">#define USB_ENDPOINT_XFER_CONTROL   0</span>
<span class="cp">#define USB_ENDPOINT_XFER_ISOC              1</span>
<span class="cp">#define USB_ENDPOINT_XFER_BULK              2</span>
<span class="cp">#define USB_ENDPOINT_XFER_INT               3</span>
<span class="cp">#define USB_ENDPOINT_MAX_ADJUSTABLE 0x80</span>
</pre></div>
</div>
<div class="highlight-c notranslate" id="usb-dir-out"><span id="usb-dir-in"></span><div class="highlight"><pre><span></span><span class="cp">#define USB_DIR_OUT                 0               </span><span class="cm">/* to device */</span>
<span class="cp">#define USB_DIR_IN                  0x80            </span><span class="cm">/* to host */</span>
</pre></div>
</div>
</section>
<section id="type-definitions">
<h3><span class="section-number">3.6.5.4. </span>Type Definitions<a class="headerlink" href="#type-definitions" title="Link to this heading"></a></h3>
<div class="highlight-c notranslate" id="desc-config"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="n">u32</span><span class="p">(</span><span class="o">*</span><span class="n">desc_config</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="n">usb_dev</span><span class="w"> </span><span class="n">usb_id</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="n">cur_itf_num</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c notranslate" id="itf-hander"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="n">u32</span><span class="p">(</span><span class="o">*</span><span class="n">itf_hander</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">usb_device_t</span><span class="w"> </span><span class="o">*</span><span class="n">usb_device</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">usb_ctrlrequest</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c notranslate" id="setup-recv"><div class="highlight"><pre><span></span><span class="n">u32</span><span class="p">(</span><span class="o">*</span><span class="n">setup_recv</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">usb_device_t</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">usb_ctrlrequest</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c notranslate" id="itf-reset-hander"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="n">itf_reset_hander</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">usb_device_t</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">itf</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c notranslate" id="usb-interrupt"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="n">usb_interrupt</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">usb_device_t</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ep</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c notranslate" id="usb-h-interrupt"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="n">usb_h_interrupt</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">usb_host_device</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ep</span><span class="p">);</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="iic.html" class="btn btn-neutral float-left" title="3.5. iic" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="rdec.html" class="btn btn-neutral float-right" title="3.7. rdec" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2010-2023, 杰理科技股份有限公司.
      <span class="lastupdated">Last updated on Oct 08, 2024.
      </span></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>